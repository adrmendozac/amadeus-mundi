import type { EndpointV2 } from "../endpoint";
import type { HandlerExecutionContext } from "../middleware";
import type { MetadataBearer } from "../response";
import type { EndpointBearer, SerdeFunctions } from "../serde";
import type { BigDecimalSchema, BigIntegerSchema, BlobSchema, BooleanSchema, DocumentSchema, NumericSchema, StreamingBlobSchema, StringSchema, TimestampDateTimeSchema, TimestampDefaultSchema, TimestampEpochSecondsSchema, TimestampHttpDateSchema } from "./sentinels";
import type { TraitBitVector } from "./traits";

export type Schema = UnitSchema | TraitsSchema | SimpleSchema | ListSchema | MapSchema | StructureSchema | MemberSchema | OperationSchema | NormalizedSchema;

export type SchemaTraits = TraitBitVector | SchemaTraitsObject;

export interface TraitsSchema {
    namespace: string;
    name: string;
    traits: SchemaTraits;
}

export type SimpleSchema = BlobSchemas | StringSchema | BooleanSchema | NumericSchema | BigIntegerSchema | BigDecimalSchema | DocumentSchema | TimestampSchemas | number;

export type TimestampSchemas = TimestampDefaultSchema | TimestampDateTimeSchema | TimestampHttpDateSchema | TimestampEpochSecondsSchema;

export type BlobSchemas = BlobSchema | StreamingBlobSchema;

export type UnitSchema = "unit";

export type SchemaTraitsObject = {
    idempotent?: 1;
    idempotencyToken?: 1;
    sensitive?: 1;
    sparse?: 1;
    
    timestampFormat?: never;
    httpLabel?: 1;
    httpHeader?: string;
    httpQuery?: string;
    httpPrefixHeaders?: string;
    httpQueryParams?: 1;
    httpPayload?: 1;
    
    http?: [string, string, number];
    httpResponseCode?: 1;
    
    endpoint?: [string];
    xmlAttribute?: 1;
    xmlName?: string;
    
    xmlNamespace?: [string, string];
    xmlFlattened?: 1;
    jsonName?: string;
    mediaType?: string;
    error?: "client" | "server";
    streaming?: 1;
    eventHeader?: 1;
    eventPayload?: 1;
    [traitName: string]: unknown;
};

export interface StructureSchema extends TraitsSchema {
    name: string;
    traits: SchemaTraits;
    memberNames: string[];
    memberList: SchemaRef[];
    
    members?: Record<string, [SchemaRef, SchemaTraits]> | undefined;
}

export interface ListSchema extends TraitsSchema {
    name: string;
    traits: SchemaTraits;
    valueSchema: SchemaRef;
}

export interface MapSchema extends TraitsSchema {
    name: string;
    traits: SchemaTraits;
    keySchema: SchemaRef;
    valueSchema: SchemaRef;
}

export type MemberSchema = [SchemaRef, SchemaTraits];

export interface OperationSchema extends TraitsSchema {
    name: string;
    traits: SchemaTraits;
    input: SchemaRef;
    output: SchemaRef;
}

export interface NormalizedSchema {
    getSchema(): Schema;
    getName(): string | undefined;
    isMemberSchema(): boolean;
    isListSchema(): boolean;
    isMapSchema(): boolean;
    isStructSchema(): boolean;
    isBlobSchema(): boolean;
    isTimestampSchema(): boolean;
    isStringSchema(): boolean;
    isBooleanSchema(): boolean;
    isNumericSchema(): boolean;
    isBigIntegerSchema(): boolean;
    isBigDecimalSchema(): boolean;
    isStreaming(): boolean;
    getMergedTraits(): SchemaTraitsObject;
    getMemberTraits(): SchemaTraitsObject;
    getOwnTraits(): SchemaTraitsObject;
    
    getValueSchema(): NormalizedSchema;
    
    getMemberSchema(member: string): NormalizedSchema | undefined;
    structIterator(): Generator<[string, NormalizedSchema], undefined, undefined>;
}

export type SchemaRef = Schema | (() => Schema);

export interface Codec<S, D> extends ConfigurableSerdeContext {
    createSerializer(): ShapeSerializer<S>;
    createDeserializer(): ShapeDeserializer<D>;
}

export type CodecSettings = {
    timestampFormat: {
        
        useTrait: boolean;
        
        default: TimestampDateTimeSchema | TimestampHttpDateSchema | TimestampEpochSecondsSchema;
    };
    
    httpBindings?: boolean;
};

export interface ShapeDeserializer<SerializationType = Uint8Array> extends ConfigurableSerdeContext {
    
    read(schema: Schema, data: SerializationType): any | Promise<any>;
}

export interface ShapeSerializer<SerializationType = Uint8Array> extends ConfigurableSerdeContext {
    write(schema: Schema, value: unknown): void;
    flush(): SerializationType;
}

export interface ClientProtocol<Request, Response> extends ConfigurableSerdeContext {
    
    getShapeId(): string;
    getRequestType(): {
        new (...args: any[]): Request;
    };
    getResponseType(): {
        new (...args: any[]): Response;
    };
    
    getPayloadCodec(): Codec<any, any>;
    serializeRequest<Input extends object>(operationSchema: OperationSchema, input: Input, context: HandlerExecutionContext & SerdeFunctions & EndpointBearer): Promise<Request>;
    updateServiceEndpoint(request: Request, endpoint: EndpointV2): Request;
    deserializeResponse<Output extends MetadataBearer>(operationSchema: OperationSchema, context: HandlerExecutionContext & SerdeFunctions, response: Response): Promise<Output>;
}

export interface ConfigurableSerdeContext {
    setSerdeContext(serdeContext: SerdeFunctions): void;
}
