
import { User } from '../auth/user';
import { DatabaseId } from '../core/database_info';
import { SequenceNumberSyncer } from '../core/listen_sequence';
import { JsonProtoSerializer } from '../remote/serializer';
import { AsyncQueue } from '../util/async_queue';
import { DocumentLike, WindowLike } from '../util/types';
import { BundleCache } from './bundle_cache';
import { DocumentOverlayCache } from './document_overlay_cache';
import { GlobalsCache } from './globals_cache';
import { IndexManager } from './index_manager';
import { IndexedDbLruDelegateImpl } from './indexeddb_lru_delegate_impl';
import { IndexedDbMutationQueue } from './indexeddb_mutation_queue';
import { IndexedDbRemoteDocumentCache } from './indexeddb_remote_document_cache';
import { IndexedDbTargetCache } from './indexeddb_target_cache';
import { LruParams } from './lru_garbage_collector';
import { Persistence, PrimaryStateListener } from './persistence';
import { PersistencePromise } from './persistence_promise';
import { PersistenceTransaction, PersistenceTransactionMode } from './persistence_transaction';
import { ClientId } from './shared_client_state';

export declare const MAIN_DATABASE = "main";

export declare class IndexedDbPersistence implements Persistence {
    
    private readonly allowTabSynchronization;
    private readonly persistenceKey;
    private readonly clientId;
    private readonly queue;
    private readonly window;
    private readonly document;
    private readonly sequenceNumberSyncer;
    
    private readonly forceOwningTab;
    private readonly schemaVersion;
    private simpleDb;
    private listenSequence;
    private _started;
    private isPrimary;
    private networkEnabled;
    private dbName;
    
    private windowUnloadHandler;
    private inForeground;
    private serializer;
    
    private documentVisibilityHandler;
    
    private clientMetadataRefresher;
    
    private lastGarbageCollectionTime;
    
    private primaryStateListener;
    private readonly globalsCache;
    private readonly targetCache;
    private readonly remoteDocumentCache;
    private readonly bundleCache;
    private readonly webStorage;
    readonly referenceDelegate: IndexedDbLruDelegateImpl;
    constructor(
    
    allowTabSynchronization: boolean, persistenceKey: string, clientId: ClientId, lruParams: LruParams, queue: AsyncQueue, window: WindowLike | null, document: DocumentLike | null, serializer: JsonProtoSerializer, sequenceNumberSyncer: SequenceNumberSyncer, 
    
    forceOwningTab: boolean, schemaVersion?: number);
    
    start(): Promise<void>;
    
    setPrimaryStateListener(primaryStateListener: PrimaryStateListener): Promise<void>;
    
    setDatabaseDeletedListener(databaseDeletedListener: () => Promise<void>): void;
    
    setNetworkEnabled(networkEnabled: boolean): void;
    
    private updateClientMetadataAndTryBecomePrimary;
    private verifyPrimaryLease;
    private removeClientMetadata;
    
    private maybeGarbageCollectMultiClientState;
    
    private scheduleClientMetadataAndPrimaryLeaseRefreshes;
    
    private isLocalClient;
    
    private canActAsPrimary;
    shutdown(): Promise<void>;
    
    private filterActiveClients;
    
    getActiveClients(): Promise<ClientId[]>;
    get started(): boolean;
    getGlobalsCache(): GlobalsCache;
    getMutationQueue(user: User, indexManager: IndexManager): IndexedDbMutationQueue;
    getTargetCache(): IndexedDbTargetCache;
    getRemoteDocumentCache(): IndexedDbRemoteDocumentCache;
    getIndexManager(user: User): IndexManager;
    getDocumentOverlayCache(user: User): DocumentOverlayCache;
    getBundleCache(): BundleCache;
    runTransaction<T>(action: string, mode: PersistenceTransactionMode, transactionOperation: (transaction: PersistenceTransaction) => PersistencePromise<T>): Promise<T>;
    
    private verifyAllowTabSynchronization;
    
    private acquireOrExtendPrimaryLease;
    static isAvailable(): boolean;
    
    private releasePrimaryLeaseIfHeld;
    
    private isWithinAge;
    private attachVisibilityHandler;
    private detachVisibilityHandler;
    
    private attachWindowUnloadHook;
    private detachWindowUnloadHook;
    
    private isClientZombied;
    
    private markClientZombied;
    
    private removeClientZombiedEntry;
    private zombiedClientLocalStorageKey;
}

export declare function indexedDbStoragePrefix(databaseId: DatabaseId, persistenceKey: string): string;
export declare function indexedDbClearPersistence(persistenceKey: string): Promise<void>;
