
import { User } from '../auth/user';
import { TargetId } from '../core/types';
import { DocumentKey } from '../model/document_key';
import { BundleCache } from './bundle_cache';
import { DocumentOverlayCache } from './document_overlay_cache';
import { GlobalsCache } from './globals_cache';
import { IndexManager } from './index_manager';
import { MutationQueue } from './mutation_queue';
import { PersistencePromise } from './persistence_promise';
import { PersistenceTransaction, PersistenceTransactionMode } from './persistence_transaction';
import { RemoteDocumentCache } from './remote_document_cache';
import { TargetCache } from './target_cache';
import { TargetData } from './target_data';

export type PrimaryStateListener = (isPrimary: boolean) => Promise<void>;

export interface ReferenceDelegate {
    
    addReference(txn: PersistenceTransaction, targetId: TargetId, doc: DocumentKey): PersistencePromise<void>;
    
    removeReference(txn: PersistenceTransaction, targetId: TargetId, doc: DocumentKey): PersistencePromise<void>;
    
    removeTarget(txn: PersistenceTransaction, targetData: TargetData): PersistencePromise<void>;
    
    markPotentiallyOrphaned(txn: PersistenceTransaction, doc: DocumentKey): PersistencePromise<void>;
    
    updateLimboDocument(txn: PersistenceTransaction, doc: DocumentKey): PersistencePromise<void>;
}

export interface Persistence {
    
    readonly started: boolean;
    readonly referenceDelegate: ReferenceDelegate;
    
    start(): Promise<void>;
    
    shutdown(): Promise<void>;
    
    setDatabaseDeletedListener(databaseDeletedListener: () => Promise<void>): void;
    
    setNetworkEnabled(networkEnabled: boolean): void;
    
    getGlobalsCache(): GlobalsCache;
    
    getMutationQueue(user: User, indexManager: IndexManager): MutationQueue;
    
    getTargetCache(): TargetCache;
    
    getRemoteDocumentCache(): RemoteDocumentCache;
    
    getBundleCache(): BundleCache;
    
    getIndexManager(user: User): IndexManager;
    
    getDocumentOverlayCache(user: User): DocumentOverlayCache;
    
    runTransaction<T>(action: string, mode: PersistenceTransactionMode, transactionOperation: (transaction: PersistenceTransaction) => PersistencePromise<T>): Promise<T>;
}

export interface Scheduler {
    readonly started: boolean;
    start(): void;
    stop(): void;
}
