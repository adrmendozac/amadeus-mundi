
import { DatabaseId } from '../core/database_info';
import { SnapshotVersion } from '../core/snapshot_version';
import { TargetId } from '../core/types';
import { TargetData } from '../local/target_data';
import { DocumentKeySet } from '../model/collections';
import { MutableDocument } from '../model/document';
import { DocumentKey } from '../model/document_key';
import { ByteString } from '../util/byte_string';
import { FirestoreError } from '../util/error';
import { ExistenceFilter } from './existence_filter';
import { RemoteEvent } from './remote_event';

export type WatchChange = DocumentWatchChange | WatchTargetChange | ExistenceFilterChange;

export declare class DocumentWatchChange {
    
    updatedTargetIds: TargetId[];
    
    removedTargetIds: TargetId[];
    
    key: DocumentKey;
    
    newDoc: MutableDocument | null;
    constructor(
    
    updatedTargetIds: TargetId[], 
    
    removedTargetIds: TargetId[], 
    
    key: DocumentKey, 
    
    newDoc: MutableDocument | null);
}
export declare class ExistenceFilterChange {
    targetId: TargetId;
    existenceFilter: ExistenceFilter;
    constructor(targetId: TargetId, existenceFilter: ExistenceFilter);
}
export declare const enum WatchTargetChangeState {
    NoChange = 0,
    Added = 1,
    Removed = 2,
    Current = 3,
    Reset = 4
}
export declare class WatchTargetChange {
    
    state: WatchTargetChangeState;
    
    targetIds: TargetId[];
    
    resumeToken: ByteString;
    
    cause: FirestoreError | null;
    constructor(
    
    state: WatchTargetChangeState, 
    
    targetIds: TargetId[], 
    
    resumeToken?: ByteString, 
    
    cause?: FirestoreError | null);
}

export interface TargetMetadataProvider {
    
    getRemoteKeysForTarget(targetId: TargetId): DocumentKeySet;
    
    getTargetDataForTarget(targetId: TargetId): TargetData | null;
    
    getDatabaseId(): DatabaseId;
}

export declare class WatchChangeAggregator {
    private metadataProvider;
    constructor(metadataProvider: TargetMetadataProvider);
    
    private targetStates;
    
    private pendingDocumentUpdates;
    private pendingDocumentUpdatesByTarget;
    
    private pendingDocumentTargetMapping;
    
    private pendingTargetResets;
    
    handleDocumentChange(docChange: DocumentWatchChange): void;
    
    handleTargetChange(targetChange: WatchTargetChange): void;
    
    forEachTarget(targetChange: WatchTargetChange, fn: (targetId: TargetId) => void): void;
    
    handleExistenceFilter(watchChange: ExistenceFilterChange): void;
    
    private parseBloomFilter;
    
    private applyBloomFilter;
    
    private filterRemovedDocuments;
    
    createRemoteEvent(snapshotVersion: SnapshotVersion): RemoteEvent;
    
    addDocumentToTarget(targetId: TargetId, document: MutableDocument): void;
    
    removeDocumentFromTarget(targetId: TargetId, key: DocumentKey, updatedDocument: MutableDocument | null): void;
    removeTarget(targetId: TargetId): void;
    
    private getCurrentDocumentCountForTarget;
    
    recordPendingTargetRequest(targetId: TargetId): void;
    private ensureTargetState;
    private ensureDocumentTargetMapping;
    private ensureDocumentUpdateByTarget;
    
    protected isActiveTarget(targetId: TargetId): boolean;
    
    protected targetDataForActiveTarget(targetId: TargetId): TargetData | null;
    
    private resetTarget;
    
    private targetContainsDocument;
}
