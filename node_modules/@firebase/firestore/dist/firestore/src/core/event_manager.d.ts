
import { FirestoreError } from '../util/error';
import { EventHandler } from '../util/misc';
import { ObjectMap } from '../util/obj_map';
import { Query } from './query';
import { OnlineState } from './types';
import { ViewSnapshot } from './view_snapshot';

declare class QueryListenersInfo {
    viewSnap: ViewSnapshot | undefined;
    listeners: QueryListener[];
    hasRemoteListeners(): boolean;
}

export interface Observer<T> {
    next: EventHandler<T>;
    error: EventHandler<FirestoreError>;
}

export interface EventManager {
    onListen?: (query: Query, enableRemoteListen: boolean) => Promise<ViewSnapshot>;
    onUnlisten?: (query: Query, disableRemoteListen: boolean) => Promise<void>;
    onFirstRemoteStoreListen?: (query: Query) => Promise<void>;
    onLastRemoteStoreUnlisten?: (query: Query) => Promise<void>;
    terminate(): void;
}
export declare function newEventManager(): EventManager;
export declare class EventManagerImpl implements EventManager {
    queries: ObjectMap<Query, QueryListenersInfo>;
    onlineState: OnlineState;
    snapshotsInSyncListeners: Set<Observer<void>>;
    
    onListen?: (query: Query, enableRemoteListen: boolean) => Promise<ViewSnapshot>;
    
    onUnlisten?: (query: Query, disableRemoteListen: boolean) => Promise<void>;
    
    onFirstRemoteStoreListen?: (query: Query) => Promise<void>;
    
    onLastRemoteStoreUnlisten?: (query: Query) => Promise<void>;
    terminate(): void;
}
export declare function eventManagerListen(eventManager: EventManager, listener: QueryListener): Promise<void>;
export declare function eventManagerUnlisten(eventManager: EventManager, listener: QueryListener): Promise<void>;
export declare function eventManagerOnWatchChange(eventManager: EventManager, viewSnaps: ViewSnapshot[]): void;
export declare function eventManagerOnWatchError(eventManager: EventManager, query: Query, error: FirestoreError): void;
export declare function eventManagerOnOnlineStateChange(eventManager: EventManager, onlineState: OnlineState): void;
export declare function addSnapshotsInSyncListener(eventManager: EventManager, observer: Observer<void>): void;
export declare function removeSnapshotsInSyncListener(eventManager: EventManager, observer: Observer<void>): void;
export declare enum ListenerDataSource {
    
    Default = "default",
    
    Cache = "cache"
}
export interface ListenOptions {
    
    readonly includeMetadataChanges?: boolean;
    
    readonly waitForSyncWhenOnline?: boolean;
    
    readonly source?: ListenerDataSource;
}

export declare class QueryListener {
    readonly query: Query;
    private queryObserver;
    
    private raisedInitialEvent;
    private options;
    private snap;
    private onlineState;
    constructor(query: Query, queryObserver: Observer<ViewSnapshot>, options?: ListenOptions);
    
    onViewSnapshot(snap: ViewSnapshot): boolean;
    onError(error: FirestoreError): void;
    
    applyOnlineStateChange(onlineState: OnlineState): boolean;
    private shouldRaiseInitialEvent;
    private shouldRaiseEvent;
    private raiseInitialEvent;
    listensToRemoteStore(): boolean;
}
export {};
