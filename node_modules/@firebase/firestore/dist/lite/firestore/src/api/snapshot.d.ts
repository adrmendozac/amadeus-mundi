
import { ChangeType, ViewSnapshot } from '../core/view_snapshot';
import { FieldPath } from '../lite-api/field_path';
import { DocumentData, PartialWithFieldValue, Query, SetOptions, WithFieldValue } from '../lite-api/reference';
import { DocumentSnapshot as LiteDocumentSnapshot, FirestoreDataConverter as LiteFirestoreDataConverter } from '../lite-api/snapshot';
import { UntypedFirestoreDataConverter } from '../lite-api/user_data_reader';
import { AbstractUserDataWriter } from '../lite-api/user_data_writer';
import { Document } from '../model/document';
import { DocumentKey } from '../model/document_key';
import { Property } from '../util/json_validation';
import { Firestore } from './database';
import { SnapshotListenOptions } from './reference_impl';

export interface FirestoreDataConverter<AppModelType, DbModelType extends DocumentData = DocumentData> extends LiteFirestoreDataConverter<AppModelType, DbModelType> {
    
    toFirestore(modelObject: WithFieldValue<AppModelType>): WithFieldValue<DbModelType>;
    
    toFirestore(modelObject: PartialWithFieldValue<AppModelType>, options: SetOptions): PartialWithFieldValue<DbModelType>;
    
    fromFirestore(snapshot: QueryDocumentSnapshot<DocumentData, DocumentData>, options?: SnapshotOptions): AppModelType;
}

export interface SnapshotOptions {
    
    readonly serverTimestamps?: 'estimate' | 'previous' | 'none';
}

export declare class SnapshotMetadata {
    
    readonly hasPendingWrites: boolean;
    
    readonly fromCache: boolean;
    
    constructor(hasPendingWrites: boolean, fromCache: boolean);
    
    isEqual(other: SnapshotMetadata): boolean;
}

export type DocumentChangeType = 'added' | 'removed' | 'modified';

export interface DocumentChange<AppModelType = DocumentData, DbModelType extends DocumentData = DocumentData> {
    
    readonly type: DocumentChangeType;
    
    readonly doc: QueryDocumentSnapshot<AppModelType, DbModelType>;
    
    readonly oldIndex: number;
    
    readonly newIndex: number;
}

export declare class DocumentSnapshot<AppModelType = DocumentData, DbModelType extends DocumentData = DocumentData> extends LiteDocumentSnapshot<AppModelType, DbModelType> {
    readonly _firestore: Firestore;
    private readonly _firestoreImpl;
    
    readonly metadata: SnapshotMetadata;
    
    constructor(_firestore: Firestore, userDataWriter: AbstractUserDataWriter, key: DocumentKey, document: Document | null, metadata: SnapshotMetadata, converter: UntypedFirestoreDataConverter<AppModelType, DbModelType> | null);
    
    exists(): this is QueryDocumentSnapshot<AppModelType, DbModelType>;
    
    data(options?: SnapshotOptions): AppModelType | undefined;
    
    get(fieldPath: string | FieldPath, options?: SnapshotOptions): any;
    static _jsonSchemaVersion: string;
    static _jsonSchema: {
        type: Property<"string">;
        bundleSource: Property<"string">;
        bundleName: Property<"string">;
        bundle: Property<"string">;
    };
    
    toJSON(): object;
}

export declare function documentSnapshotFromJSON(db: Firestore, json: object): DocumentSnapshot;

export declare function documentSnapshotFromJSON<AppModelType, DbModelType extends DocumentData = DocumentData>(db: Firestore, json: object, converter: FirestoreDataConverter<AppModelType, DbModelType>): DocumentSnapshot<AppModelType, DbModelType>;

export declare class QueryDocumentSnapshot<AppModelType = DocumentData, DbModelType extends DocumentData = DocumentData> extends DocumentSnapshot<AppModelType, DbModelType> {
    
    data(options?: SnapshotOptions): AppModelType;
}

export declare class QuerySnapshot<AppModelType = DocumentData, DbModelType extends DocumentData = DocumentData> {
    readonly _firestore: Firestore;
    readonly _userDataWriter: AbstractUserDataWriter;
    readonly _snapshot: ViewSnapshot;
    
    readonly metadata: SnapshotMetadata;
    
    readonly query: Query<AppModelType, DbModelType>;
    private _cachedChanges?;
    private _cachedChangesIncludeMetadataChanges?;
    
    constructor(_firestore: Firestore, _userDataWriter: AbstractUserDataWriter, query: Query<AppModelType, DbModelType>, _snapshot: ViewSnapshot);
    
    get docs(): Array<QueryDocumentSnapshot<AppModelType, DbModelType>>;
    
    get size(): number;
    
    get empty(): boolean;
    
    forEach(callback: (result: QueryDocumentSnapshot<AppModelType, DbModelType>) => void, thisArg?: unknown): void;
    
    docChanges(options?: SnapshotListenOptions): Array<DocumentChange<AppModelType, DbModelType>>;
    static _jsonSchemaVersion: string;
    static _jsonSchema: {
        type: Property<"string">;
        bundleSource: Property<"string">;
        bundleName: Property<"string">;
        bundle: Property<"string">;
    };
    
    toJSON(): object;
}

export declare function querySnapshotFromJSON(db: Firestore, json: object): QuerySnapshot;

export declare function querySnapshotFromJSON<AppModelType, DbModelType extends DocumentData = DocumentData>(db: Firestore, json: object, converter: FirestoreDataConverter<AppModelType, DbModelType>): QuerySnapshot<AppModelType, DbModelType>;

export declare function changesFromSnapshot<AppModelType, DbModelType extends DocumentData>(querySnapshot: QuerySnapshot<AppModelType, DbModelType>, includeMetadataChanges: boolean): Array<DocumentChange<AppModelType, DbModelType>>;
export declare function resultChangeType(type: ChangeType): DocumentChangeType;

export declare function snapshotEqual<AppModelType, DbModelType extends DocumentData>(left: DocumentSnapshot<AppModelType, DbModelType> | QuerySnapshot<AppModelType, DbModelType>, right: DocumentSnapshot<AppModelType, DbModelType> | QuerySnapshot<AppModelType, DbModelType>): boolean;
