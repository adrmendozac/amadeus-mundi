

import {onBFCacheRestore} from './lib/bfcache.js';
import {bindReporter} from './lib/bindReporter.js';
import {initMetric} from './lib/initMetric.js';
import {
  DEFAULT_DURATION_THRESHOLD,
  processInteractionEntry,
  estimateP98LongestInteraction,
  resetInteractions,
} from './lib/interactions.js';
import {observe} from './lib/observe.js';
import {onHidden} from './lib/onHidden.js';
import {initInteractionCountPolyfill} from './lib/polyfills/interactionCountPolyfill.js';
import {whenActivated} from './lib/whenActivated.js';
import {whenIdle} from './lib/whenIdle.js';

import {INPMetric, MetricRatingThresholds, ReportOpts} from './types.js';


export const onINP = (
  onReport: (metric: INPMetric) => void,
  opts?: ReportOpts,
) => {
  
  if (
    !(
      'PerformanceEventTiming' in self &&
      'interactionId' in PerformanceEventTiming.prototype
    )
  ) {
    return;
  }

  
  opts = opts || {};

  whenActivated(() => {
    
    initInteractionCountPolyfill();

    let metric = initMetric('INP');
    let report: ReturnType<typeof bindReporter>;

    const handleEntries = (entries: INPMetric['entries']) => {
      
      
      
      
      
      
      whenIdle(() => {
        entries.forEach(processInteractionEntry);

        const inp = estimateP98LongestInteraction();

        if (inp && inp.latency !== metric.value) {
          metric.value = inp.latency;
          metric.entries = inp.entries;
          report();
        }
      });
    };

    const po = observe('event', handleEntries, {
      
      
      
      
      
      
      durationThreshold: opts!.durationThreshold ?? DEFAULT_DURATION_THRESHOLD,
    });

    report = bindReporter(
      onReport,
      metric,
      INPThresholds,
      opts!.reportAllChanges,
    );

    if (po) {
      
      
      po.observe({type: 'first-input', buffered: true});

      onHidden(() => {
        handleEntries(po.takeRecords() as INPMetric['entries']);
        report(true);
      });

      
      
      onBFCacheRestore(() => {
        resetInteractions();

        metric = initMetric('INP');
        report = bindReporter(
          onReport,
          metric,
          INPThresholds,
          opts!.reportAllChanges,
        );
      });
    }
  });
};
